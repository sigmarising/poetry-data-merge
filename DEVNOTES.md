# 开发笔记

## 1. 数据来源

* [国学大师 - 诗词曲库](http://www.guoxuedashi.com/shici/)
* [八斗文学](http://www.8dou.net/)

## 2. 数据预处理

* 使用工程1的原始 input 数据（`input\guoxuedashi`）
* 使用工程2的 output 数据（`input\8dou`）

手动进行下列处理：
1. 移除八斗文学数据集的：`不明`、`当代`、`近代`、`现代`
2. 统一两批数据集朝代：`元`、`先秦`、`南北朝`、`唐`、`宋`、`明`、`汉`、`清`、`辽`、`金`、`隋`、`魏晋`
3. 将八斗文学的部分不合法文件名进行特殊处理：
   1. 移除文件名中非重复作者的多余数字
   2. 移除部分文件名中无法解析的字符（方块等）
   3. 将所有“诗经”的诗词合并到一个文件中

## 3. 处理要点

* 统计两个数据集/合并数据集的：
  * 各朝代各诗人作品数量
  * 各朝代诗人总数、作品总数
  * 总体的诗人数量、作品数量
* 对于 utf-8 无法解析的字符，进行忽略 `errors=ignore`
* 对于每个 string 进行 strip 操作
* 分离正文和注释
* 由于 strip 的原因，在同一数据集内可能存在两首相同的诗
* 对于国学大师数据集，删除 intro 条目
* 对于国学大师数据集，分离 `【注释】【赏析】【译文】` 到 `comments` 中
* 对于国学大师数据集，诗歌正文中的 `{x[d]y}` 数据，转换为`x`（去掉了`{`和`[d]y}`）
* 对于国学大师数据集，应拆分 `\r\n \n \r \n\r`
* 对于两份数据集，去掉正文中的 `【...】（...）[...](...)`
* 对于两份数据集，移除正文内容为空的诗
* 目标输出：

```json
{
    "dynasty": obj["dynasty"],
    "author": obj["author"],
    "poems": [{
        "title": obj["title"],
        "content": obj["content"],
        "comment": obj["comment"]
    }]
}
```

## 4. 去重方法

对于一首待加入的诗词 A，由于在不同的数据集中，A 的题目表示方法可能有差异，但是能够确定的一定是 `朝代-作者` （strip 之后）的一致性。所以对于 A 而言，应当与已经处理好的作者文件中的所有诗词比较相似性，才能达到一个相对较好的去重。（对于正文相似而题目不一致的诗词A 和 B，应当保留题目、作者信息量较大的诗词，并将两者的comment进行合并）

相似性计算方法：按照诗词正文的字划分（不进行分词）来构建 VSM，字频计算方法为 `该字的出现次数 / 当前向量中出现的最大次数`，计算余弦夹角值并对比设定的阈值，来判断是否相似

对于 A 匹配到的所有 `朝代-诗人` 的作品 list B，for item in B：
* 比较 A 和 item 的正文中指定前 n 个字符是否一致（初筛并加速）：
  * 若子串一致 则比较 A 和 item 正文相似性
    * 正文达到余弦相似性阈值的，舍弃这样的 A
  * 若子串不一致 continue
* 若所有 item 比较之后均未达到阈值，则加入 A 到 list B 中

## 5. 优化策略

由于在不同的数据集中读取，都是按照一个个文件（也就是一个个作者而来的），所以在合并时，只有当数据集1或数据集2中正在处理的那个作者文件处理完毕时，outputHandler才会将结果输出到json文件中，以减少对于文件IO而阻塞CPU计算。

同时采用了基于正文前n个字符的子串比较初筛方法，大大减少了不必要的余弦相似性计算。
